<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#009578">
    <title>MAP 2.0</title>

    <link rel="stylesheet" href="./dist/leaflet/leaflet.css" >
    <link rel="stylesheet" href="https://rawgit.com/aratcliffe/Leaflet.contextmenu/master/dist/leaflet.contextmenu.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>

    <script src="./dist/leaflet/leaflet.js"></script>
    <script src="https://rawgit.com/aratcliffe/Leaflet.contextmenu/master/dist/leaflet.contextmenu.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://erasta.github.io/Leaflet.RotatedMarker/leaflet.rotatedMarker.js"></script>

    <!-- <script type="module" src="./js/hostility.js"></script> -->
    <!-- <script type="module" src="./js/marker.js"></script> -->

    <!-- <script src="./js/flyTo.js" ></script>
    <script src="./js/contextMenu.js" ></script>
    <script src="./js/plotMarker.js" ></script> -->
    
    
    <style>
        
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 99%;
			width: 99%;
			max-width: 100%;
			max-height: 100%;
		}

        #map { height: 100%; width: 100%; }
	
    </style>
</head>

<body>
    <div id="map" class="leaflet-container leaflet-touch leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0"></div>

    <script type="module">
        import { checkhostilityAISandGetMarker, isIDLocateFreeToPlot, newPointMarkerAIS,newPointMarkerAMS_TEDUNG, 
            isMinuteAgo, checkhostilityTEDUNG_AMSandGetMarker, newPointMarkerKurita, checkhostilityKuritaSandGetMarker,
            checkMarkerHostility } from './js/marker.js'
        import { drawSetting }  from './js/draw.js';
        
        
        // load maps
        const map = L.map('map',{ zoomControl: false, contextmenu: true, }).setView([3.07987, 101.68146], 8); //set zoom 13
        const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        let layerSites = L.layerGroup();
        var editableLayers = L.featureGroup().addTo(map);
        var drawControl = new L.Control.Draw(drawSetting(editableLayers));
        map.addControl(drawControl);

        // Plot latitude and longitude to center maps
        const search = L.control({position: 'topleft', collapsed: false})
        search.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'command');
            div.innerHTML = "Lat, Long : <input id='latlong'/><button id='search'>Go</button>"
            return div;
        }
        search.addTo(map)

        // event draw for created
        map.on('draw:created', function(e) {
        var type = e.layerType,
            layer = e.layer;
            editableLayers.addLayer(layer);
        });

        // add the event handler button Go
        document.getElementById("search").addEventListener ("click", handlePointLatLong, false);
        function handlePointLatLong() {
            latlong = document.getElementById("latlong").value;
            coor = splitKoma(latlong);
            map.flyTo(L.latLng(coor[0], coor[1]), 8);
        }

        // let sse = new EventSource('https://myhardrockbit.asuscomm.com:5051/esscom-cop-mq/consume?lastData=1');
        let sse = new EventSource('http://192.168.0.114:8081/sse_event');
        // let sse = new EventSource('http://192.168.137.76:8081/sse_event');
        
        sse.onmessage = function(e){

            // console.log("On Message")
            
            let raw = JSON.parse(e.data)
            let sensor = raw['sensor']
            let track = raw['update_track']
            // console.log(track, "UPDATE TRACK")
            update_track(track)
            
            // datas = e
            let ais = sensor['AIS']
            let ams_tedung = sensor['AMS/Tedung']
            // bft = datas['BFT']
            // boat_tracker = datas['Boat Tracker']
            // imsi = datas['IMSI']
            // camar = datas['Camar']
            // individual = datas['Individual/Drone']
            let kurita = sensor['Kurita']

            plotKurita(kurita)
            // plotCamar(camar)
            // plotIndividual(individual)
            // plotImsi(imsi)
            // plotBoat_tracker(boat_tracker)
            // plotBft(bft)
            console.log("tedung", ams_tedung)
            plotAms_tedung(ams_tedung)
            // console.log("ais", ais)
            plotAis(ais)
        };

        // {id: '525011169', key: 'hostility', value: '1', sensor: 'AIS'

        function update_track(list_track) {
            for (var i=0, l=list_track.length; i < l; i++){
                let raw = list_track[i];
                let icon = checkMarkerHostility(raw)
                if (raw['sensor'] == 'AIS'){
                    lookupAis[raw['id']].setIcon(icon)
                }else if(raw['sensor'] == 'AMS'){
                    lookupAmsTedung[raw['id']].setIcon(icon)
                }
            }

        }

        const lookupAis = {}
        function plotAis(params){
            let removeIDs = Object.keys(lookupAis);

            for (var i=0, l=params.length; i < l; i++){
                let infos = params[i];
                let id = infos['id']
                let coor = infos['latlong']
                
                if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupAis))){        // no id
                    // console.log("XXX")
                    lookupAis[id] = newPointMarkerAIS([coor[0], coor[1]], infos)
                    layerSites.addLayer(lookupAis[id])
                    layerSites.addTo(map)
                    // console.log("pppp")

                }else{

                    let newLatLng = new L.LatLng(coor[1], coor[0]);
                    lookupAis[id].setLatLng(newLatLng); 

                    // let iconImg = checkhostilityAISandGetMarker(infos['hostility'])
                    lookupAis[id].setIcon(checkhostilityAISandGetMarker(infos['hostility']))
                }
            }
            removeMarker(removeIDs, lookupAis); 
        }

        const lookupAmsTedung = {}
        function plotAms_tedung(params){
            let removeIDs = Object.keys(lookupAmsTedung);

            for (var i=0, l=params.length; i < l; i++){
                let infos = params[i];
                let id = infos['id']
                let coor = infos['latlong']
                
                if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupAmsTedung))){        // no id
                    lookupAmsTedung[id] = newPointMarkerAMS_TEDUNG(infos['latitude'],infos['longitude'], infos)
                    layerSites.addLayer(lookupAmsTedung[id])
                    layerSites.addTo(map)

                }else{

                //     const LeafIcon = L.Icon.extend({
                //     options: {
                //         shadowUrl: 'leaf-shadow.png',
                //         iconSize:     [38, 95],
                //         shadowSize:   [0, 0],
                //         iconAnchor:   [22, 94],
                //         shadowAnchor: [4, 62],
                //         popupAnchor:  [-3, -76]
                //     }
                // });
                // let iconColor_old = new LeafIcon({
                //         iconUrl: './dist/leaflet/images/marker/tedung_ais/tedung_yellow.png',
                //         shadowUrl: './dist/leaflet/images/marker-shadow.png'
                //     })

                    // lookupAmsTedung[id].setIcon(iconColor_old);
                    
                    // lookupAmsTedung[id] = newPointMarkerAMS_TEDUNG(infos['latitude'],infos['longitude'], infos)
                    // layerSites.addLayer(lookupAmsTedung[id])
                    // layerSites.addTo(map)

                    // let newLatLng = new L.LatLng(coor[1], coor[0]);
                    // lookupAmsTedung[id].setLatLng(newLatLng); 

                    

                    // lookupAmsTedung[id].setIcon(checkhostilityTEDUNG_AMSandGetMarker(infos['hostility']))
                }
            }
            removeMarker(removeIDs, lookupAmsTedung); 
        }

        const lookupKurita = {}
        function plotKurita(params){
            let removeIDs = Object.keys(lookupKurita);

            for (var i=0, l=params.length; i < l; i++){
                let infos = params[i];
                let id = infos['id']
                let coor = infos['latlong']
                
                if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupKurita))){        // no id
                    lookupKurita[id] = newPointMarkerKurita([coor[0], coor[1]], infos)
                    layerSites.addLayer(lookupKurita[id])
                    layerSites.addTo(map)

                }else{

                    let newLatLng = new L.LatLng(coor[1], coor[0]);
                    lookupKurita[id].setLatLng(newLatLng); 

                    // let iconImg;
                    // if ("hostility" in infos){
                    //     iconImg = checkhostilityKuritaSandGetMarker(infos['hostility'])
                    // }else{
                    //     iconImg = checkhostilityKuritaSandGetMarker('1')
                    // }
                    // console.log(iconImg, "Kurita")
                    lookupKurita[id].setIcon(checkhostilityKuritaSandGetMarker(infos['hostility']))
                }
            }
            removeMarker(removeIDs, lookupKurita); 
        }

        function removeMarker(params, lookUp){
            for (var i=0, l=params.length; i < l; i++){
                if (isMinuteAgo(lookUp[params[i]]['options']['datetimePlot'])){
                    map.removeLayer(lookUp[params[i]])
                }
            }
        }


        // L.marker([51.5, -0.09], {
        //         rotationAngle: 90,
        //         icon: new L.Icon.Default().options.shadowSize = [0,0]
        //         // draggable: true
        //     }).addTo(map);

    //     let iconColor = L.icon({
    //                     // iconUrl: 'https://leafletjs.com/examples/custom-icons/leaf-green.png',
    //                     iconUrl: './dist/leaflet/images/marker-icon.png',
    //                     shadowUrl: 'https://leafletjs.com/examples/custom-icons/leaf-shadow.png',
    //                     className: 'u-turn-icon'
    //                 })

    // const LeafIcon = L.Icon.extend({
	// 	options: {
	// 		shadowUrl: 'leaf-shadow.png',
	// 		iconSize:     [38, 95],
	// 		shadowSize:   [0, 0],
	// 		iconAnchor:   [22, 94],
	// 		shadowAnchor: [4, 62],
	// 		popupAnchor:  [-3, -76]
	// 	}
	// });

	// const greenIcon = new LeafIcon({iconUrl: './dist/leaflet/images/marker-icon.png', shadowUrl: 'https://leafletjs.com/examples/custom-icons/leaf-shadow.png',});

    //     var icon = new L.Icon.Default();
    //     icon.options.shadowSize = [0,0];
    //     var marker = new L.Marker([ 2.025054,103.038140], {rotationAngle: 180,icon : greenIcon}).addTo(map);
        


        // lookupCamar = {}
        // function plotCamar(params){
        //     let removeIDs = Object.keys(lookupCamar);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];
        //         id = infos['id']

        //         if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupCamar))){        // no id
        //             coor = infos['latlong']
        //             lookupCamar[id] = L.marker([coor[1], coor[0]], {
        //                 contextmenu: true,
        //                 contextmenuWidth: 200,
        //                 contextmenuItems: [{
        //                     text: 'Context Menu 1', callback:contextMenu1
        //                 },{
        //                     text: 'Context Menu 2', callback:contextMenu2
        //                 },{
        //                     text: 'Context Menu 3', callback:contextMenu3
        //                 }]
        //             })
        //             .bindPopup('ID: '+ id)

        //             var layerSites = L.layerGroup();
        //             layerSites.addLayer(lookupCamar[id])
        //             layerSites.addTo(map)
        //         }else{
                    
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

        // lookupIndividual = {}
        // function plotIndividual(params){
        //     let removeIDs = Object.keys(lookupIndividual);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupIndividual))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupIndividual[id] = L.marker([coor[1], coor[0]], {
        //                 contextmenu: true,
        //                 contextmenuWidth: 200,
        //                 contextmenuItems: [{
        //                     text: 'Context Menu 1', callback:contextMenu1
        //                 },{
        //                     text: 'Context Menu 2', callback:contextMenu2
        //                 },{
        //                     text: 'Context Menu 3', callback:contextMenu3
        //                 }]
        //             })
        //             .bindPopup('ID: '+ id)

        //             var layerSites = L.layerGroup();
        //             layerSites.addLayer(lookupIndividual[id])
        //             layerSites.addTo(map)
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

        // lookupImsi = {}
        // function plotImsi(params){
        //     let removeIDs = Object.keys(lookupImsi);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupImsi))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupImsi[id] = L.marker([coor[1], coor[0]], {
        //                 contextmenu: true,
        //                 contextmenuWidth: 200,
        //                 contextmenuItems: [{
        //                     text: 'Context Menu 1', callback:contextMenu1
        //                 },{
        //                     text: 'Context Menu 2', callback:contextMenu2
        //                 },{
        //                     text: 'Context Menu 3', callback:contextMenu3
        //                 }]
        //             })
        //             .bindPopup('ID: '+ id)

        //             var layerSites = L.layerGroup();
        //             layerSites.addLayer(lookupImsi[id])
        //             layerSites.addTo(map)
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

        // lookupBoatTracker = {}
        // function plotBoat_tracker(params){
        //     let removeIDs = Object.keys(lookupBoatTracker);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupBoatTracker))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupBoatTracker[id] = L.marker([coor[1], coor[0]], {
        //                 contextmenu: true,
        //                 contextmenuWidth: 200,
        //                 contextmenuItems: [{
        //                     text: 'Context Menu 1', callback:contextMenu1
        //                 },{
        //                     text: 'Context Menu 2', callback:contextMenu2
        //                 },{
        //                     text: 'Context Menu 3', callback:contextMenu3
        //                 }]
        //             })
        //             .bindPopup('ID: '+ id)

        //             var layerSites = L.layerGroup();
        //             layerSites.addLayer(lookupBoatTracker[id])
        //             layerSites.addTo(map)
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

        // lookupBoatBft = {}
        // function plotBft(params){
        //     let removeIDs = Object.keys(lookupBoatBft);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupBoatBft))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupBoatBft[id] = L.marker([coor[1], coor[0]], {
        //                 contextmenu: true,
        //                 contextmenuWidth: 200,
        //                 contextmenuItems: [{
        //                     text: 'Context Menu 1', callback:contextMenu1
        //                 },{
        //                     text: 'Context Menu 2', callback:contextMenu2
        //                 },{
        //                     text: 'Context Menu 3', callback:contextMenu3
        //                 }]
        //             })
        //             .bindPopup('ID: '+ id)

        //             var layerSites = L.layerGroup();
        //             layerSites.addLayer(lookupBoatBft[id])
        //             layerSites.addTo(map)
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

       

        // lookupAis = {}
        // function plotAis(params){
        //     let removeIDs = Object.keys(lookupAis);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFree(infos['id'], Object.keys(lookupAis))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupAis[id] = L.marker([coor[1], coor[0]]).addTo(map);
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }
    
    </script>
</body>
</html>