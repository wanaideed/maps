<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#009578">
    <title>MAP 2.0</title>

    <link rel="stylesheet" href="./dist/leaflet/leaflet.css" >
    <!-- <link rel="stylesheet" href="https://rawgit.com/aratcliffe/Leaflet.contextmenu/master/dist/leaflet.contextmenu.css" /> -->
    <link rel="stylesheet" href="./css/leaflet.contextmenu.css" >
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/> -->
    <link rel="stylesheet" href="./css/leaflet.draw.css" >
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"> -->

    <script src="./dist/leaflet/leaflet.js"></script>
    
    <script src="https://rawgit.com/aratcliffe/Leaflet.contextmenu/master/dist/leaflet.contextmenu.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>


    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> -->
    
    <script src="./js/leaflet.polylineDecorator.js"></script>
    <!-- <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script> -->
    <script src="https://erasta.github.io/Leaflet.RotatedMarker/leaflet.rotatedMarker.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath@1.2.0/leaflet.textpath.min.js"></script>

    <!-- <script type="module" src="./js/hostility.js"></script> -->
    <!-- <script type="module" src="./js/marker.js"></script> -->

    <!-- <script src="./js/flyTo.js" ></script> -->
    <!--<script src="./js/contextMenu.js" ></script>
    <script src="./js/plotMarker.js" ></script> -->
    
    
    <style>
        
		html, body {
			height: 100%;
			margin: 0;
		}
		.leaflet-container {
			height: 99%;
			width: 99%;
			max-width: 100%;
			max-height: 100%;
		}

        #map { height: 100%; width: 100%; }
            .leaflet-tooltip.my-labels {
                background-color: black;
                color: white;
                /* border: transparent; */
                box-shadow: none;
                padding: 0px 3px 0px 3px;
                font-size: xx-small;
            }

            .leaflet-tooltip.label-ais{
                background-color: black;
                color: white;
                /* border: transparent; */
                box-shadow: none;
                padding: 0px 3px 0px 3px;
                font-size: xx-small;
            }

            .leaflet-tooltip.context-menu{
                background-color: transparent;
                color: white;
                /* border: transparent; */
                box-shadow: none;
                padding: 0px 3px 0px 3px;
                font-size: xx-small;
            }

            /* .leaflet-contextmenu { */
                /* background-color: black;
                color: white; */
                /* border: transparent; */
                /* box-shadow: none;
                padding: 0px 3px 0px 3px;
                font-size: xx-small;       */
            /* } */
    </style>
</head>

<body>
    <div><button onclick="radarLayer('0.02')">0.2 nm</button>
        <button onclick="radarLayer('0.05')">0.5 nm</button>
        <button onclick="radarLayer('0.1')">1 nm</button>
        <button onclick="radarLayer('0.2')">2 nm</button>
        <button onclick="radarLayer('0.5')">5 nm</button>
        <button onclick="radarLayer('1')">10 nm</button>
        <button onclick="radarLayer('2')">20 nm</button>
        <button onclick="radarLayer('5')">50 nm</button>
        <button onclick="radarLayer('10')">100 nm</button>
        <button onclick="radarLayer('20')">200 nm</button>
        <button onclick="radarLayer('50')">500 nm</button>
    </div>
    <div><button onclick="aisLayer()">Ais Data</button>
        <button onclick="aisLayerLabel()">Ais Label</button>
        <button onclick="tedungLayer()">AMS Data</button>
        <button onclick="tedungLayerLabel()">AMS Label</button>
        <button onclick="camarLayer()">CAMAR</button>
        <button onclick="bearingScaleLayer()">Bearing</button>
        <button onclick="scanningLayer()">Radar Scanning</button>
        <button onclick="radarRangeDisable()">Radar Range Remove</button>
        <!-- <button onclick="radarLayer('2')">20 nm</button>
        <button onclick="radarLayer('5')">50 nm</button>
        <button onclick="radarLayer('10')">100 nm</button>
        <button onclick="radarLayer('20')">200 nm</button>
        <button onclick="radarLayer('50')">500 nm</button> -->
    </div>
    <div id="map" class="leaflet-container leaflet-touch leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0"></div>
    <!-- <div><button onclick="radarLayer()">xxxxx</button><button onclick="aisLayer(false)">vvvvvv</button></div> -->
    <script>
        function radarRangeDisable(){radarRangeDisableToggle0()}

        function scanningLayer(){scanningLayerToggleO()}

        function bearingScaleLayer(){bearingScaleToggleO()}

        function rangeRingLayer(){rangeRingToggleO()}

        function camarLayer(){camarLayerToggleO()}

        function tedungLayer(){tedungLayerToggleO()}
        function tedungLayerLabel(){tedungLayerToggleLabelO()}

        function aisLayer(){aisLayerToggleO()}
        function aisLayerLabel(){aisLayerToggleLabelO()}

        function kuritaLayer(){kuritaLayerToggleO()}

        function radarLayer(keyName){createRange(keyName)}


    </script>

    <script type="module">
        import { checkhostilityAISandGetMarker, isIDLocateFreeToPlot, newPointMarkerAIS,newPointMarkerAMS_TEDUNG, 
            isMinuteAgo, checkhostilityTEDUNG_AMSandGetMarker, newPointMarkerKurita, checkhostilityKuritaSandGetMarker,plotBase,addlabelMarkerAIS,
            checkMarkerHostility, addlabelMarkerTedung } from './js/marker.js'
        import { drawSetting }  from './js/draw.js';
        
      
        // load maps
        var center = [4.234571, 100.611687], radarbeam = {"type":"LineString", "coordinates": [[center[1], center[0]], [center[1], center[0]]]};

        const map = L.map('map',
            { 
                zoomDelta: 1,
                zoomSnap: 0.5 ,
                zoomControl: true, 
                contextmenu: true, 
                scrollWheelZoom: false, 
                doubleClickZoom: false,
                dragging: false,
                maxZoom: 18,minZoom:6, //11
                // layers: [tiles]
            }).setView([4.2345254, 100.611677], 12); 
        
        let radarLayer = L.layerGroup();
        let bearingScaleLayer = L.layerGroup();
        let rangeRingLayer = L.layerGroup();
        let camarLayer = L.layerGroup();

        let tedungLayer = L.layerGroup();
        let tedungLayerTracker = L.layerGroup();
        let tedungLayerLabel = L.layerGroup();

        let aisLayerLabel = L.layerGroup();
        let aisLayerMain = L.layerGroup();
        let aisLayerTracker = L.layerGroup();

        let kuritaLayer = L.layerGroup();
        
        // --------------- Setting Click event from puty python --------
        
        let showradarLayer, showbearingScaleLayer, showrangeRingLayer, showcamarLayer, showtedungLayer,showtedungLayerLabel, showaisLayer, showaisLayerLabel, showkuritaLayer = false;
        function scanningLayerToggle(){
            showradarLayer = !showradarLayer
            if (showradarLayer){ radarLayer.addTo(map) }else{ map.removeLayer(radarLayer) }
            
        }

        function bearingScaleToggle(){
            showbearingScaleLayer = !showbearingScaleLayer
            if (showbearingScaleLayer){ bearingScaleLayer.addTo(map) }else{ map.removeLayer(bearingScaleLayer) }
            
        }

        function rangeRingToggle(){
            showrangeRingLayer = !showrangeRingLayer
            if (showrangeRingLayer){ rangeRingLayer.addTo(map) }else{ map.removeLayer(rangeRingLayer) }
            
        }

        function camarLayerToggle(){
            showcamarLayer = !showcamarLayer
            if (showcamarLayer){ camarLayer.addTo(map) }else{ map.removeLayer(camarLayer) }
            
        }

        function tedungLayerToggle(){
            showtedungLayer = !showtedungLayer
            if (showtedungLayer){ tedungLayer.addTo(map) }else{ map.removeLayer(tedungLayer) }
            
        }

        function tedungLayerLabelToggle(){
            showtedungLayerLabel = !showtedungLayerLabel
            if (showtedungLayerLabel){ tedungLayerLabel.addTo(map) }else{ map.removeLayer(tedungLayerLabel) }
        }

        function aisLayerToggle(){
            showaisLayer = !showaisLayer
            if (showaisLayer){ 
                aisLayerMain.addTo(map)
            }else{ 
                map.removeLayer(aisLayerMain)
            }
            
        }

        function aisLayerLabelToggle(){
            showaisLayerLabel = !showaisLayerLabel
            if (showaisLayerLabel){ 
                aisLayerLabel.addTo(map)
            }else{ 
                map.removeLayer(aisLayerLabel)
            }
        }

        function kuritaLayerToggle(){
            showkuritaLayer = !showkuritaLayer
            if (showkuritaLayer){ kuritaLayer.addTo(map) }else{ map.removeLayer(kuritaLayer) }
            
        }

        function radarRangeDisableToggle() {
            map.removeLayer(rangeRingLayer);
        }

        window.scanningLayerToggleO = scanningLayerToggle
        window.bearingScaleToggleO = bearingScaleToggle
        window.rangeRingToggleO = rangeRingToggle
        window.camarLayerToggleO = camarLayerToggle
        window.tedungLayerToggleO = tedungLayerToggle
        window.tedungLayerToggleLabelO = tedungLayerLabelToggle
        window.aisLayerToggleO = aisLayerToggle
        window.aisLayerToggleLabelO = aisLayerLabelToggle
        window.kuritaLayerToggleO = kuritaLayerToggle
        window.radarRangeDisableToggle0 = radarRangeDisableToggle
        window.showTails = function (id, flagBool){
            // console.log(map.contextmenu())
            // lookupAis[id].relatedTarget
            //  map.contextmenu.hide()
            if(flagBool){
                console.log(lookupAis[id+"array"], "Value Array")
                lookupAis[id+"polyline"] = new L.polyline(lookupAis[id+'array'], {weight: '0.75'})
                lookupAis[id+"polyline_deco"] = L.polylineDecorator(lookupAis[id+"polyline"], {patterns: [{
                        offset: 0,
                        repeat: 10,
                        symbol: L.Symbol.dash({
                            pathOptions: {
                            color: '#000000',
                            weight: 4
                        },
                            pixelSize: 0
                        })
                }]})
                lookupAis[id+"polyline"].addTo(aisLayerTracker)
                lookupAis[id+"polyline_deco"].addTo(aisLayerTracker)
                aisLayerTracker.addTo(map)
            }else{
                aisLayerTracker.removeLayer(aisLayerTracker[id+"polyline"])
                aisLayerTracker.removeLayer(aisLayerTracker[id+"polyline_deco"])
                delete lookupAis[id+"polyline"]
                delete lookupAis[id+"polyline_deco"]
                console.log(lookupAis[id+"polyline"], "OOOOOO")
            }
        }

       
        window.showTailsAMS = function (id, flagBool){
            // console.log(flagBool, "AMS")
            if(flagBool){
                console.log(lookupAmsTedung[id+"array"], "Value Array")
                lookupAmsTedung[id+"polyline"] = new L.polyline(lookupAmsTedung[id+'array'], {weight: '0.75'})
                lookupAmsTedung[id+"polyline_deco"] = L.polylineDecorator(lookupAmsTedung[id+"polyline"], {patterns: [{
                        offset: 0,
                        repeat: 10,
                        symbol: L.Symbol.dash({
                            pathOptions: {
                            color: '#000000',
                            weight: 4
                        },
                            pixelSize: 0
                        })
                }]})
                lookupAmsTedung[id+"polyline"].addTo(tedungLayerTracker)
                lookupAmsTedung[id+"polyline_deco"].addTo(tedungLayerTracker)
                tedungLayerTracker.addTo(map)
                // tedungLayerTracker.addTo(map)
            }else{
                tedungLayerTracker.removeLayer(lookupAmsTedung[id+"polyline"])
                tedungLayerTracker.removeLayer(lookupAmsTedung[id+"polyline_deco"])
                delete lookupAmsTedung[id+"polyline"]
                delete lookupAmsTedung[id+"polyline_deco"]
                console.log(lookupAmsTedung[id+"polyline"], "OOOOOO")
            }
        }


        const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map)

        const mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>';
        // const serverIP = "http://localhost:8081/"
        const serverIP = "http://192.168.0.107:8081/"
        const satelit = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {id: 'mapbox/satellite-v9', tileSize: 512, zoomOffset: -1, attribution: mbAttr})
        const empty = L.tileLayer('');
      
        
        // const baseLayers = {
        //     'OpenStreetMap': tiles,
        //     'Satellite': satelit,
        //     'Empty Maps': empty
        // };

        // const overlays = {
        //     'Range Ring': rangeRingLayer,
        //     'Bearing Scale': bearingScaleLayer,
        //     'Scannig': radarLayer,
        //     // 'Ais Data': aisLayerMain,
        //     // 'Ais Label': aisLayerLabel,
        //     'Camar': camarLayer,
        //     // 'AMS/Tedung': tedungLayer,
        //     // 'AMS Label': tedungLayerLabel,
        //     'Kurita': kuritaLayer,
        // };

        // L.control.layers(baseLayers, overlays, {collapsed: false}).addTo(map)
        // L.control.layers({'OpenStreetMap': tiles},{collapsed: false}).addTo(map)
        L.control.layers({'OpenStreetMap': tiles, 'Satellite': satelit, 'Empty Maps': empty}, {}, {collapsed: false}).addTo(map)

        // -----------  Bearing Scale Layer ----------------
        let angleTick = [];
        var xy1 = map.options.crs.project(L.latLng(center));
        
        [10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180,190,200, 210, 220, 230, 240,250, 260, 270, 280, 290, 300, 310, 320, 330, 340, 350, 360].forEach(function(angle) {
                let ply;
                if(angle == 90 || angle == 360 || angle==180 || angle==270 ){
                    ply = L.polyline([
                        
                        map.options.crs.unproject(L.point([
                            xy1.x + Math.sin(angle * Math.PI / 180) * 15000,
                            xy1.y + Math.cos(angle * Math.PI / 180) * 15000
                        ])),
                        map.options.crs.unproject(L.point([
                            xy1.x + Math.sin(angle * Math.PI / 180) * (0),
                            xy1.y + Math.cos(angle * Math.PI / 180) * (0)
                        ]))
                    ],
                        {weight: 2, color: '#808080'}
                    ).setText(angle.toString(), { orientation: 'perpendicular', attributes: { 'font-size':'1.3em'}}).addTo(bearingScaleLayer)
                }else{
                    ply = L.polyline([
                        
                        map.options.crs.unproject(L.point([
                            xy1.x + Math.sin(angle * Math.PI / 180) * 15000,
                            xy1.y + Math.cos(angle * Math.PI / 180) * 15000
                        ])),
                        map.options.crs.unproject(L.point([
                            xy1.x + Math.sin(angle * Math.PI / 180) * (15000 - (15000 / 11)),
                            xy1.y + Math.cos(angle * Math.PI / 180) *  (15000 - (15000 / 11)),
                        ]))
                    ],
                        {weight: 1, color: '#808080'}
                    ).setText(angle.toString(), { orientation: 'perpendicular',attributes: { 'font-size':'1.3em'}}).addTo(bearingScaleLayer)
                }
                angleTick.push(ply);
            });
        let circleBearing = L.circle(center, {radius: 15000,fill: false,weight: 2,color: '#808080'}).addTo(bearingScaleLayer)
        var myZoom = {
        start:  map.getZoom(),
        end: map.getZoom()
        };
        
        map.on('zoomstart', function(e) {
            // console.log("ZOOMSTART", e);
            console.log( map.getZoom())
            console.log(round(map.getZoom()))
            myZoom.start = round(map.getZoom());
        });

        // map.on('zoom', function() {

        //     console.log(map.getZoom())

        // });

        map.on('zoomend', function(e) {
            angleTick.forEach(function(e){bearingScaleLayer.removeLayer(e)})
            console.log( round(map.getZoom()), 'zoomed')
            let newRadius;
            myZoom.end = round(map.getZoom());
            // radius = {"18": "234.375", "17": "468.75", "16": "937.5", "15": "1875","14": "3750", "13": "7500", "12": "15000", "11": "30000", "10": "60000","9": "120000","8": "240000","7": "480000"}
            // let newRadius = radius[map.getZoom().toString()];
            // console.log(newRadius)
            
            
            var diff = myZoom.start - myZoom.end;
            console.log(diff, "diff")
            console.log("circlebearing", circleBearing.getRadius())
            
            if (diff > 0) {
                newRadius = circleBearing.getRadius() * 2
                console.log("##")
            } else if (diff < 0) {
                newRadius = circleBearing.getRadius() / 2
                console.log("@@@@@")
            }else{
                newRadius = circleBearing.getRadius() 
            }
            // console.log(map.options.crs.unproject(L.point([
            //                 xy1.x + Math.sin(100 * Math.PI / 180) * newRadius,
            //                 xy1.y + Math.cos(100 * Math.PI / 180) * newRadius
            //             ])))
            let vradius = {"18": "234.375", "17": "468.75", "16": "937.5", "15": "1875","14": "3750", "13": "10000", "12": "20000", "11": "40000", "10": "60000","9": "120000","8": "240000","7": "480000", "6":"960000"}
            let vnewRadius = vradius[round(map.getZoom()).toString()];
            console.log(map.getZoom())
            console.log(round(map.getZoom()));
            console.log(Math.floor(vnewRadius), "Radius Dict")
                console.log(newRadius, "Radius")
                // circleBearing.setLatLng()
                // circleBearing.setLatLng(center)
                newRadius = vnewRadius
            circleBearing.setRadius(Math.floor(vnewRadius));
            let xy1 = map.options.crs.project(L.latLng(center));
            [10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180,190,200, 210, 220, 230, 240,250, 260, 270, 280, 290, 300, 310, 320, 330, 340, 350, 360].forEach(function(angle) {
                let ply;
                if(angle == 90 || angle == 360 || angle==180 || angle==270 ){
                    ply = L.polyline([
                        map.options.crs.unproject(L.point([
                            xy1.x + Math.sin(angle * Math.PI / 180) * newRadius,
                            xy1.y + Math.cos(angle * Math.PI / 180) * newRadius
                        ])),
                        map.options.crs.unproject(L.point([
                            xy1.x + Math.sin(angle * Math.PI / 180) * (0),
                            xy1.y + Math.cos(angle * Math.PI / 180) * (0),
                        ]))
                    ],
                        {weight: 1, color: '#808080'}
                    ).setText(angle.toString(), { orientation: 'perpendicular',attributes: { 'font-size':'1.3em'}}).addTo(bearingScaleLayer)
                }else{
                    ply = L.polyline([
                        map.options.crs.unproject(L.point([
                            xy1.x + Math.sin(angle * Math.PI / 180) * newRadius,
                            xy1.y + Math.cos(angle * Math.PI / 180) * newRadius
                        ])),
                        map.options.crs.unproject(L.point([
                            xy1.x + Math.sin(angle * Math.PI / 180) * (newRadius - (newRadius / 11)),
                            xy1.y + Math.cos(angle * Math.PI / 180) * (newRadius - (newRadius / 11))
                        ]))
                    ],
                        {weight: 1, color: '#808080'}
                    ).setText(angle.toString(), { orientation: 'perpendicular',attributes: { 'font-size':'1.3em'}}).addTo(bearingScaleLayer)
                }
                    angleTick.push(ply);
                });
        });

        // ----------- Range Ring Layer -------------------
        let lvlRange = {
            "0.02" : [37.04, 74.08, 111.12, 148.16, 185.2, 222.24, 259.28, 296.32, 333.36, 370.4],
            "0.05" :[92.6, 185.2, 277.8, 370.4, 463, 555.6, 648.2, 740.8, 833.4, 926],
            "0.1" :[185.2, 370.4, 555.6, 740.8, 926, 1111.2, 1296.4, 1481.6, 1666.8, 1852],
            "0.2" :[370.4, 740.8, 1111.2, 1481.6, 1852, 2222.4, 2592.8, 2963.2, 3333.6, 3704],
            "0.5" :[926, 1852, 2778, 3704, 4630, 5556, 6482, 7408, 8334, 9260],
            "1" :[1852, 3704, 5556, 7408, 9260, 11112, 12964, 14816, 16668, 18520],
            "2" :[3704, 7408, 11112, 14816, 18520, 22224, 25928, 29632, 33336, 37040],
            "5" :[9260, 18520, 27780, 37040, 46300, 55560, 64820, 74080, 83340, 92600],
            "10" :[18520, 37040, 55560, 74080, 92600, 111120, 129640, 148160, 166680, 185200],
            "20" :[37040, 74080, 111120, 148160, 185200, 222240, 259280, 296320, 333360, 370400],
            "50" :[92600, 185200, 277800, 370400, 463000, 555600, 648200, 740800, 833400, 926000]
        }
        
        window.createRange = function (keyRange){
            // map.removeLayer(rangeRingLayer)
            rangeRingLayer.clearLayers()
            
            const panZoom = {"0.02": "17", "0.05": "16", "0.1": "15", "0.2": "14", "0.5": "12.5", "1": "11.5", "2": "10.5", "5": "9", "10": "8","20": "7","50": "6",}
            map.setView(center,panZoom[keyRange])
            // map.setZoom(panZoom[keyRange])
            let i = 0, count = 1;
            lvlRange[keyRange].forEach(function(r){
                i = parseFloat(keyRange) * count
                L.circle(
                    center, {
                        radius: r,
                        fill: false,
                        weight: 1.5,
                        color: '#808080'
                    }
                ).addTo(rangeRingLayer)
                let point  = L.point(xy1).add([0, r])
                L.tooltip({
                    permanent: true,
                    direction: 'center',
                    className: "my-labels"
                })
                .setContent( parseFloat(i).toFixed(2) + " nm")
                .setLatLng(map.options.crs.unproject(point))
                .addTo(rangeRingLayer)
                count = count + 1
            })

            rangeRingLayer.addTo(map)
        }
       
        


        // ------------ Radar rotation layer --------------
        let xyRadar = map.options.crs.project(L.latLng(center));
        var rings = [];
            [3704].forEach(function(r) {
                rings.push(
                    L.circle(
                        center, {
                            radius: r,
                            fill: false,
                            weight: r % 1000 == 0 ? 1.75 : 0.75,
                            color: '#808080'
                        }
                    ).addTo(radarLayer)
                );
            });


        var xy1 = map.options.crs.project(L.latLng(center)),
            radius = 3704;
        var right = L.point(xy1).add([radius, 0]),
            left = L.point(xy1).subtract([radius, 0]),
            tops = L.point(xy1).add([0, radius]),
            bottom = L.point(xy1).subtract([0, radius]);
        

        var crosshairs = [
            L.polyline([map.options.crs.unproject(left), map.options.crs.unproject(right)], {weight: 1.5, color: '#808080'}).addTo(radarLayer),
            L.polyline([map.options.crs.unproject(tops), map.options.crs.unproject(bottom)], {weight: 1.5, color: '#808080'}).addTo(radarLayer),
        ];

        var radar = L.geoJSON(
                radarbeam, {
                onEachFeature : function(feature, layer) {
                    var arclength = 2;
                    var sumangle = 360;

                    // sector is the slice of circle we'll use as a "beam shadow"
                    // aswell use it to test point-in-polygon for aircraft icon fade-out
                    var sector = {
                        type:"Polygon",
                        coordinates: [ [
                            feature.coordinates[0], feature.coordinates[1],
                            feature.coordinates[1], feature.coordinates[0]]]
                    };

                    var beamshadow = L.geoJSON(
                        sector, {
                        style: function(feature){
                            return {
                                opacity:0.75,
                                color: '#109856',
                                weight:0.2,
                                className:'radar-hand'
                            }
                        }
                    }).addTo(radarLayer)

                    setInterval(function(){
                        // animate "radar beam"
                        if (sumangle >= 360) {
                            sumangle = 0;
                        } else {
                            sumangle += arclength;
                        }
                        var beamlatlngs = layer.getLatLngs(),
                            beamshadowlatlngs = beamshadow.getLayers()[0].getLatLngs();

                        // calculate a new location for the beam linestring.

                        beamlatlngs[1] = map.options.crs.unproject(
                            L.point([
                                xy1.x + Math.sin(sumangle * Math.PI / 180) * radius,
                                xy1.y + Math.cos(sumangle * Math.PI / 180) * radius
                            ])
                        );

                        // and a new location for the trailing corner of the beam shadow

                        beamshadowlatlngs[0][1] = map.options.crs.unproject(
                            L.point([
                                xy1.x + Math.sin((sumangle - 5 * arclength) * Math.PI / 180) * radius,
                                xy1.y + Math.cos((sumangle - 5 * arclength) * Math.PI / 180) * radius
                            ])
                        );

                        var next = [beamshadowlatlngs[0][0], beamlatlngs[1], beamshadowlatlngs[0][1], beamshadowlatlngs[0][0]];
                        beamshadow.getLayers()[0].setLatLngs(next);
                        layer.setLatLngs(beamlatlngs).bringToFront();

                    }, 10);
                },
                style: function(feature) {
                    return {color: '#109856', weight: 3, opacity:0.5}
                }
            }).addTo(radarLayer)

            // radarLayer.addTo(map)

        // ---------- Sensor / Ship plot -------------------
        L.marker(center, {
            icon: plotBase()
        }).addTo(map);

        
        // --------- Get SSE and Multi function plot --------
        let sse = new EventSource(serverIP + "sse_event");
        
        sse.onmessage = function(e){
            let raw = JSON.parse(e.data)
            let sensor = raw['sensor']
            let track = raw['update_track']
            update_track(track)

            let ais = sensor['AIS']
            let ams_tedung = sensor['AMS/Tedung']
            let camar = sensor['Camar']
            let kurita = sensor['Kurita']

            // console.log(">>>>>> AIS ", ais.length)
            // console.log(">>>>>> Tedung ", ams_tedung.length)
            // console.log(">>>>>> Camar ", camar.length)

            plotKurita(kurita)
            plotCamar(camar)
            plotAms_tedung(ams_tedung)
            plotAis(ais)
        };


        function removeMarker(params, lookUp){
            for (var i=0, l=params.length; i < l; i++){
                if (isMinuteAgo(lookUp[params[i]]['options']['datetimePlot'])){
                    map.removeLayer(lookUp[params[i]])
                }
            }
        }

        function update_track(list_track) {
            for (var i=0, l=list_track.length; i < l; i++){
                let raw = list_track[i];
                let icon = checkMarkerHostility(raw)
                if (raw['sensor'] == 'AIS'){
                    lookupAis[raw['id']].setIcon(icon)
                }else if(raw['sensor'] == 'AMS'){
                    lookupAmsTedung[raw['id']].setIcon(icon)
                }
            }
        }
        
        // ---------- Function AIS plot ------------------
        const lookupAis = {}
        function plotAis(params){
            let removeIDs = Object.keys(lookupAis);

            for (var i=0, l=params.length; i < l; i++){
                let infos = params[i];
                let id = infos['id']
                let coor = infos['latlong']
                
                if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupAis))){        // no id
                    lookupAis[id] = newPointMarkerAIS([infos['latitude'],infos['longitude']], infos)
                    lookupAis[id+"label"] = addlabelMarkerAIS(infos)

                    let polyArray = [];
                    polyArray.push([infos['latitude'],infos['longitude']])
                    lookupAis[id+'array'] = polyArray

                    aisLayerLabel.addLayer(lookupAis[id+"label"])
                    aisLayerMain.addLayer(lookupAis[id])
                  

                }else{
                    let prevLatLng = lookupAis[id].getLatLng();
                    let prev = new L.LatLng(prevLatLng['lat'], prevLatLng['lng'])
                    let current = new L.LatLng(infos['latitude'], infos['longitude'])

                    if(!prev.equals(current)){
                        let all = lookupAis[id+'array']
                        all.push([infos['latitude'],infos['longitude']])
                        lookupAis[id+'array'] = all

                        if (lookupAis[id+"polyline"] !== undefined){
                            lookupAis[id+"polyline"].addLatLng(new L.LatLng(infos['latitude'],infos['longitude'] ))
                            lookupAis[id+"polyline_deco"].setPaths( lookupAis[id+"polyline"] )
                        }
                       
                        lookupAis[id].setRotationAngle(infos['heading'])
                        lookupAis[id].setLatLng(new L.LatLng(infos['latitude'], infos['longitude'])); 
                        lookupAis[id+"label"].setLatLng(new L.LatLng(infos['latitude'], infos['longitude']))
                       
                    }
                    lookupAis[id].setIcon(checkhostilityAISandGetMarker(infos['hostility']))
                }
            }
            // removeMarker(removeIDs, lookupAis); 
        }
        // aisLayer.addTo(map)
        // aisLayerMain.addTo(map)

        // ------------- Function Tedung / AMS plot ----------
        const lookupAmsTedung = {}
        function plotAms_tedung(params){
            let removeIDs = Object.keys(lookupAmsTedung);
            for (var i=0, l=params.length; i < l; i++){
                let infos = params[i];
                let id = infos['id']
                let coor = infos['latlong']
                
                if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupAmsTedung))){        // no id
                    lookupAmsTedung[id] = newPointMarkerAMS_TEDUNG(infos['latitude'],infos['longitude'], infos)
                    lookupAmsTedung[id+"label"] = addlabelMarkerTedung(infos)

                    let polyArray = [];
                    polyArray.push([infos['latitude'],infos['longitude']])
                    lookupAmsTedung[id+'array'] = polyArray

                    // let polyArray = [];
                    // polyArray.push([infos['latitude'],infos['longitude']])

                    
                    // lookupAmsTedung[id+"polyline"] = new L.polyline(polyArray, {weight: '0'})
                    // lookupAmsTedung[id+"polyline_deco"] = L.polylineDecorator(lookupAmsTedung[id+"polyline"], {patterns: [{
                    //         offset: 0,
                    //         repeat: 10,
                    //         symbol: L.Symbol.dash({
                    //             pathOptions: {
                    //             color: '#000000',
                    //             weight: 4
                    //         },
                    //             pixelSize: 0
                    //         })
                    // }]})

                    tedungLayer.addLayer(lookupAmsTedung[id])
                    // tedungLayer.addLayer(lookupAmsTedung[id+"polyline"]);
                    // tedungLayer.addLayer(lookupAmsTedung[id+"polyline_deco"])
                    tedungLayerLabel.addLayer(lookupAmsTedung[id+"label"])
                    

                }else{

                    let prevLatLng = lookupAmsTedung[id].getLatLng();
                    let prev = new L.LatLng(prevLatLng['lat'], prevLatLng['lng'])
                    let current = new L.LatLng(infos['latitude'], infos['longitude'])

                    if(!prev.equals(current)){
                        let all = lookupAmsTedung[id+'array']
                        all.push([infos['latitude'],infos['longitude']])
                        lookupAmsTedung[id+'array'] = all

                        if (lookupAmsTedung[id+"polyline"] !== undefined){
                            lookupAmsTedung[id+"polyline"].addLatLng(new L.LatLng(infos['latitude'],infos['longitude'] ))
                            lookupAmsTedung[id+"polyline_deco"].setPaths( lookupAmsTedung[id+"polyline"] )
                        }
                    // if(infos['latitude'] != prevLatLng['lat'] && infos['longitude'] != prevLatLng['lng']){
                        // lookupAmsTedung[id+"polyline"].addLatLng(new L.LatLng(infos['latitude'],infos['longitude'] ))
                        // lookupAmsTedung[id+"polyline_deco"].setPaths( lookupAmsTedung[id+"polyline"] )
                        lookupAmsTedung[id].setRotationAngle(infos['heading'])
                        lookupAmsTedung[id].setLatLng(new L.LatLng(infos['latitude'], infos['longitude'])); 
                        lookupAmsTedung[id+"label"].setLatLng(new L.LatLng(infos['latitude'], infos['longitude']))
                    }
                    
                    lookupAmsTedung[id].setIcon(checkhostilityTEDUNG_AMSandGetMarker(infos['hostility']))
                }
            }
            // removeMarker(removeIDs, lookupAmsTedung); 
        }
        // tedungLayer.addTo(map)
        // tedungLayerLabel.addTo(map)

        //-------------- Function Kurita plot ------------
        const lookupKurita = {}
        function plotKurita(params){
            let removeIDs = Object.keys(lookupKurita);

            for (var i=0, l=params.length; i < l; i++){
                let infos = params[i];
                let id = infos['id']
                let coor = infos['latlong']
                
                if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupKurita))){        // no id
                    lookupKurita[id] = newPointMarkerKurita([coor[0], coor[1]], infos)
                    layerSites.addLayer(lookupKurita[id])
                    layerSites.addTo(map)

                }else{

                    let newLatLng = new L.LatLng(coor[1], coor[0]);
                    lookupKurita[id].setLatLng(newLatLng); 
                    lookupKurita[id].setIcon(checkhostilityKuritaSandGetMarker(infos['hostility']))
                }
            }
            removeMarker(removeIDs, lookupKurita); 
        }

       //--------------- Function Camar plot -------------

       let lookupCamar = {}
        // let contextMane = [{
        //         text: 'Hostility 1', callback: clickContext
        //     }]
        function plotCamar(params){
            let removeIDs = Object.keys(lookupCamar);
            camarLayer.clearLayers()
            
            for (var i=0, l=params.length; i < l; i++){
                // if (smaad == 1){
                    let infos = params[i];
                let id = infos['id']
                let coor = infos['latlong']

                // let camar = newPointMarkerAIS([infos['latitude'], infos['longitude']], infos)
                let camar = L.circle([infos['latitude'], infos['longitude']], {
                    color: '#2b18d6',
                    fill: true,
                    fillColor:'#2b18d6',
                    fillOpacity: 1,
                    radius: 25,  
                    // contextmenu: true,
                    // contextmenuWidth: 200,
                    // contextmenuItems: contextMane 
                }).bindPopup('ID: ' + infos['id'] + " CAMAR")
                camarLayer.addLayer(camar)

            }
            
            removeMarker(removeIDs, lookupCamar); 
        }

        function round(value, precision) {
            var multiplier = Math.pow(10, precision || 0);
            return Math.round(value * multiplier) / multiplier;
        }
        // camarLayer.addTo(map)

        // function clickContext() {
        //     console.log("Click")
        // }
        
        //         let aisss = [{
        // "id" :"123123",
        // "heading": "80",
        // "sensor": "AIS",
        // "hostility": "1",
        // "latitude": 4.242471,
        // "longitude": 100.553965,
        //     "latlong": [4.242471,100.553965]
        
        // }]
        // plotAis(aisss)

        // let ams = [{
        // "id" :"123123",
        // "heading": "80",
        // "sensor": "AMS",
        // "hostility": "1",
        // "latitude": 4.203522,
        // "longitude": 100.567068,
        //     "latlong": [4.203522,100.567068]
        
        // }]
        // plotAms_tedung(ams)

        // plotCamar(ams)

    //    console.log(map.contextmenu, "****")
   

    //    map.on('contextmenu.select', (e)=>{
    //     console.log(e.contextmenu)
    //         // e.contextmenu.setDisabled(10)
    //         // e.contextmenu.removeItem(0)
    //         // console.log(e.contextmenu.removeItem(e.el), "OOOOOO")
    //         // console.log(e.el, "OOOOOO")
    //     });

    //     map.on('contextmenu.show', (e)=>{
    //         console.log("e.contextmenu")
    //         console.log(e.removeItem.removeItem(0))
    //         // e.contextmenu.setDisabled(10)
    //         // e.contextmenu.removeItem(0)
    //         // console.log(e.contextmenu.removeItem(e.el), "OOOOOO")
    //         // console.log(e.el, "OOOOOO")
    //     });

        // var m1 = L.marker([4.225458,100.558844]).addTo(map).on('contextmenu', onClickOo)
        // var popup = L.popup().setLatLng([4.242471,100.553965]).setContent('<p>Hello world!<br />This is a nice popup.</p>')

       

//         map.on('contextmenu',function(e){
//             console.log('plugin run!')
//         });

//         let vv = '<div class="container">' +
// '<h2>List Group With Custom Content</h2>' +
// '<div class="list-group">' +
//     '<a href="#" class="list-group-item active">' +
//         '<h4 class="list-group-item-heading">First List Group Item Heading</h4>' +
//         '<p class="list-group-item-text">List Group Item Text</p>' +
//         '</a>' +
//         '<a href="#" class="list-group-item">' +
//             ' <h4 class="list-group-item-heading">Second List Group Item Heading</h4>' +
//             ' <p class="list-group-item-text">List Group Item Text</p>' +
//             '</a> ' +
//             '<a href="#" class="list-group-item">' +
//                 ' <h4 class="list-group-item-heading">Third List Group Item Heading</h4>' +
//                 ' <p class="list-group-item-text">List Group Item Text</p>' +
//                 '</a>' +
//                 '</div>' +
//                 '</div>'

//                 function onClickOo() {
//             console.log("#")
//             L.popup([4.225458,100.558844],{ options: {
//                 className: 'contextMenu',
//                 autoClose: true,
//                 closeOnClick: true,
//             }, content: vv}).openOn(map);
//         }

        // let aissssss = [{
        // "id" :"902932",
        // "heading": "90",
        // "sensor": "AIS",
        // "hostility": "1",
        // "latitude": 4.250738,
        // "longitude": 100.600174,
        //     "latlong": [4.250738,100.600174]
        
        // }]
        // plotAms_tedung(aissssss)

        
        // console.log(smaad1._getLngRadius(), "()()()")
        // .bindTooltip('<label>xx</label>', {permanent: true, opacity: 0.7,}).openTooltip()
        
//         L.circle(center,{
//     color: 'red',
//     fillColor: '#f03',
//     fillOpacity: 0.5,
//     radius: 1000
// }).addTo(map).bindTooltip('<label>xx</label>', {permanent: true, opacity: 0.7,}).openTooltip()

// let LeafIcon = L.Icon.extend({
//         options: {
//             shadowUrl: 'leaf-shadow.png',
//             iconSize:     [18,  18],
//             shadowSize:   [0, 0],
//             // iconAnchor:   [2, 0],
//         // shadowAnchor: [4, 62],
//         // popupAnchor:  [-3, -76]
//         }
//     });

//         let iconColor = new LeafIcon({
//             iconUrl: './dist/leaflet/images/marker/AIS/ais_black.png',
//             shadowUrl: './dist/leaflet/images/marker-shadow.png'
//         })


//     L.marker(new L.LatLng(4.145207,100.569577), {
//         // rotationAngle: 270,
//         // datetimePlot: toMilisecond(),
//         icon: iconColor
//     }).addTo(map)
//     L.marker([4.145207,100.569577], {
//                 // rotationAngle: 90,
//                 // draggable: true
//             }).addTo(map);

        // const layerControl = L.control.layers(baseLayers, overlays, {collapsed: false}).addTo(map);


        // let layerSites = L.layerGroup();
        // let layerPolyline = L.layerGroup();
        // var editableLayers = L.featureGroup().addTo(map);
        // var drawControl = new L.Control.Draw(drawSetting(editableLayers));
        // map.addControl(drawControl);

        // Plot latitude and longitude to center maps
        // const search = L.control({position: 'topleft', collapsed: false})
        // search.onAdd = function(map) {
        //     var div = L.DomUtil.create('div', 'command');
        //     div.innerHTML = "Lat, Long : <input id='latlongValue'/><button id='search'>Go</button>"
        //     return div;
        // }
        // search.addTo(map)

        // event draw for created
        // map.on('draw:created', function(e) {
        // var type = e.layerType,
        //     layer = e.layer;
        //     editableLayers.addLayer(layer);
        // });

        // add the event handler button Go
        // document.getElementById("search").addEventListener ("click", handlePointLatLong, false);
        // function handlePointLatLong() {
        //     latlong = document.getElementById("latlongValue").value;
        //     coor = splitKoma(latlong);
        //     map.flyTo(L.latLng(coor[0], coor[1]), 8);
        // }

        //---- radar circle draw
        // Add polar craticule


    //         let LeafIcon = L.Icon.extend({
    //             options: {
    //                 shadowUrl: 'leaf-shadow.png',
    //                 iconSize:     [25, 30],
    //                 shadowSize:   [0, 0],
    //             //     iconAnchor:   [0, 0],
    //             //     shadowAnchor: [0, 0],
    //             //     popupAnchor:  [0, 0]
    //             }
    //         });

    // let iconColor = new LeafIcon({
    //     iconUrl: './dist/leaflet/images/marker/tedung_ais/tedung_black.png',
    //     shadowUrl: './dist/leaflet/images/marker-shadow.png'
    // })

    // L.marker(new L.LatLng(4.234571, 100.611687), {
    //     rotationAngle: 270,
    //     // datetimePlot: toMilisecond(),
    //     icon: iconColor
    // }).addTo(map)
    // L.marker([4.234571, 100.611687], {
    //             rotationAngle: 90,
    //             // draggable: true
    //         }).addTo(map);

        // fd.append("data", JSON.stringify({"id": idMaker, "key": "hostility", "value": value, "sensor": sensorType}));
        // setInterval(xx, 800)

        // function xx (){

        
        //     const http = new XMLHttpRequest();
        //     http.onreadystatechange = function() {
        //         if (this.readyState == 4 && this.status == 200) {
        //             console.log("############")
        //             let raw = JSON.parse(this.responseText)
        //             console.log(raw);
        //             plot(raw)
        //         }
        //     };
        //     http.open("GET", "data.json");
        //     http.send();
        // }

        // let smad = 1
        // let marker;
        // let makerleaflet = [[4.207707,100.593133],[4.208328,100.597943],[4.208080,100.605333],[4.208124,100.613274], [4.194314,100.624864]]
        // let vv = new L.polyline(makerleaflet, {weight: '0', offset:0, repeat:10,pixelSize:0}).addTo(map)
        // var pd = L.polylineDecorator(vv, {
        // patterns: [{
            
        //     offset: 0,
        //     repeat: 10,
        //     symbol: L.Symbol.dash({
        //         pathOptions: {
        //         color: '#f00',
        //         weight: 7
        //     },
        //         pixelSize: 0
        //     })
        // }]
        // }).addTo(map);
        // L.marker([4.207707,100.593133]).addTo(map)

        // setTimeout(function () {
        //     vv.addLatLng(new L.LatLng(4.173927,100.634726))
        //     pd.setPaths(vv)
        //     console.log("XXXXX")
        // }, 2000)
        // let poly;

        // console.log(new L.LatLng(3.2222,  100.12222), "()()()()()()()()")
        // function plot(xx){
        //     // poly = new L.polyline(makerleaflet).addTo(map);
        //     for (var i=0, l=xx.length; i < l; i++){
        //         if (smad == 1){
        //             // makerleaflet.push(new L.LatLng(xx[i]['lat'], xx[i]['long']))
               
        //             marker = L.marker([xx[i]['lat'], xx[i]['long']]).addTo(map);
        //             poly = new L.polyline(makerleaflet, {
        //                 stroke: false,
        //                 color: 'white', 
        //                 weight: '3', 
        //                 dashArray: '20, 20', 
        //                 dashOffset: '20'}).addTo(map)
        //         }else{
                    
                    
        //             // makerleaflet.push(new L.LatLng(
        //             //     marker.getLatLng()['lat'],
        //             //     marker.getLatLng()['lng']
        //             //     ));
                    
        //                 // poly.addLatLng([xx[i]['lat'],  xx[i]['long']])
                        
        //             marker.setLatLng(new L.LatLng(xx[i]['lat'],  xx[i]['long']))

        //             // console.log(makerleaflet, "S")
                    

        //             console.log("8888")
        //         }
        //         smad = smad + 1
                
        //     }
            
        // }

        // // let sse = new EventSource('https://myhardrockbit.asuscomm.com:5051/esscom-cop-mq/consume?lastData=1');
        // let sse = new EventSource('http://192.168.0.108:8081/sse_event');
        // // let sse = new EventSource('http://192.168.137.76:8081/sse_event');
        
        // sse.onmessage = function(e){

        //     // console.log("On Message")
            
        //     let raw = JSON.parse(e.data)
        //     let sensor = raw['sensor']
        //     let track = raw['update_track']
        //     console.log(track, "UPDATE TRACK")
        //     update_track(track)
            
        //     // datas = e
        //     // let ais = sensor['AIS']
        //     let ams_tedung = sensor['AMS/Tedung']
        //     // bft = datas['BFT']
        //     // boat_tracker = datas['Boat Tracker']
        //     // imsi = datas['IMSI']
        //     let camar = sensor['Camar']
        //     // individual = datas['Individual/Drone']
        //     // let kurita = sensor['Kurita']

        //     // plotKurita(kurita)
        //     plotCamar(camar)
        //     // plotIndividual(individual)
        //     // plotImsi(imsi)
        //     // plotBoat_tracker(boat_tracker)
        //     // plotBft(bft)
        //     // console.log("tedung", ams_tedung)
        //     plotAms_tedung(ams_tedung)
        //     // console.log("ais", ais)
        //     // plotAis(ais)
        // };

        // {id: '525011169', key: 'hostility', value: '1', sensor: 'AIS'

        // map.on('zoomend', function(e) {
            
        //     map.setView([4.234571, 100.611687]);
        // });

        // map.on('moveend', function(e) {
        //     map.setView([4.234571, 100.611687]);
        // });






        // L.marker([51.5, -0.09], {
        //         rotationAngle: 90,
        //         icon: new L.Icon.Default().options.shadowSize = [0,0]
        //         // draggable: true
        //     }).addTo(map);

    //     let iconColor = L.icon({
    //                     // iconUrl: 'https://leafletjs.com/examples/custom-icons/leaf-green.png',
    //                     iconUrl: './dist/leaflet/images/marker-icon.png',
    //                     shadowUrl: 'https://leafletjs.com/examples/custom-icons/leaf-shadow.png',
    //                     className: 'u-turn-icon'
    //                 })

    // const LeafIcon = L.Icon.extend({
	// 	options: {
	// 		shadowUrl: 'leaf-shadow.png',
	// 		iconSize:     [38, 95],
	// 		shadowSize:   [0, 0],
	// 		iconAnchor:   [22, 94],
	// 		shadowAnchor: [4, 62],
	// 		popupAnchor:  [-3, -76]
	// 	}
	// });

	// const greenIcon = new LeafIcon({iconUrl: './dist/leaflet/images/marker-icon.png', shadowUrl: 'https://leafletjs.com/examples/custom-icons/leaf-shadow.png',});

    //     var icon = new L.Icon.Default();
    //     icon.options.shadowSize = [0,0];
    //     var marker = new L.Marker([ 2.025054,103.038140], {rotationAngle: 180,icon : greenIcon}).addTo(map);
        



        // lookupIndividual = {}
        // function plotIndividual(params){
        //     let removeIDs = Object.keys(lookupIndividual);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupIndividual))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupIndividual[id] = L.marker([coor[1], coor[0]], {
        //                 contextmenu: true,
        //                 contextmenuWidth: 200,
        //                 contextmenuItems: [{
        //                     text: 'Context Menu 1', callback:contextMenu1
        //                 },{
        //                     text: 'Context Menu 2', callback:contextMenu2
        //                 },{
        //                     text: 'Context Menu 3', callback:contextMenu3
        //                 }]
        //             })
        //             .bindPopup('ID: '+ id)

        //             var layerSites = L.layerGroup();
        //             layerSites.addLayer(lookupIndividual[id])
        //             layerSites.addTo(map)
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

        // lookupImsi = {}
        // function plotImsi(params){
        //     let removeIDs = Object.keys(lookupImsi);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupImsi))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupImsi[id] = L.marker([coor[1], coor[0]], {
        //                 contextmenu: true,
        //                 contextmenuWidth: 200,
        //                 contextmenuItems: [{
        //                     text: 'Context Menu 1', callback:contextMenu1
        //                 },{
        //                     text: 'Context Menu 2', callback:contextMenu2
        //                 },{
        //                     text: 'Context Menu 3', callback:contextMenu3
        //                 }]
        //             })
        //             .bindPopup('ID: '+ id)

        //             var layerSites = L.layerGroup();
        //             layerSites.addLayer(lookupImsi[id])
        //             layerSites.addTo(map)
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

        // lookupBoatTracker = {}
        // function plotBoat_tracker(params){
        //     let removeIDs = Object.keys(lookupBoatTracker);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupBoatTracker))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupBoatTracker[id] = L.marker([coor[1], coor[0]], {
        //                 contextmenu: true,
        //                 contextmenuWidth: 200,
        //                 contextmenuItems: [{
        //                     text: 'Context Menu 1', callback:contextMenu1
        //                 },{
        //                     text: 'Context Menu 2', callback:contextMenu2
        //                 },{
        //                     text: 'Context Menu 3', callback:contextMenu3
        //                 }]
        //             })
        //             .bindPopup('ID: '+ id)

        //             var layerSites = L.layerGroup();
        //             layerSites.addLayer(lookupBoatTracker[id])
        //             layerSites.addTo(map)
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

        // lookupBoatBft = {}
        // function plotBft(params){
        //     let removeIDs = Object.keys(lookupBoatBft);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFreeToPlot(infos['id'], Object.keys(lookupBoatBft))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupBoatBft[id] = L.marker([coor[1], coor[0]], {
        //                 contextmenu: true,
        //                 contextmenuWidth: 200,
        //                 contextmenuItems: [{
        //                     text: 'Context Menu 1', callback:contextMenu1
        //                 },{
        //                     text: 'Context Menu 2', callback:contextMenu2
        //                 },{
        //                     text: 'Context Menu 3', callback:contextMenu3
        //                 }]
        //             })
        //             .bindPopup('ID: '+ id)

        //             var layerSites = L.layerGroup();
        //             layerSites.addLayer(lookupBoatBft[id])
        //             layerSites.addTo(map)
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

       

        // lookupAis = {}
        // function plotAis(params){
        //     let removeIDs = Object.keys(lookupAis);

        //     for (var i=0, l=params.length; i < l; i++){
        //         let infos = params[i];

        //         if(isIDLocateFree(infos['id'], Object.keys(lookupAis))){        // no id
        //             coor = infos['latlong']
        //             id = infos['id']
        //             lookupAis[id] = L.marker([coor[1], coor[0]]).addTo(map);
        //         }else{
        //             let index = removeIDs.indexOf(i);
        //             removeIDs.splice(index, 1)
        //         }
        //     }
            
        //     removeMarker(removeIDs); 
        // }

   
    
    </script>
</body>
</html>